<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduGate | Add Grade (Faculty Secretary)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="main-bg">

<header class="d-flex justify-content-between align-items-center px-4 py-3 shadow bg-white">
  <a href="faculty_secretary_home.html" class="d-flex align-items-center text-decoration-none text-dark">
    <img src="logo.png" alt="EduGate Logo" class="logo-small" />
    <span class="ms-2 fw-bold fs-5">EduGate</span>
  </a>
  <h4 class="m-0 text-center flex-grow-1 fw-bold">
    Add Grade (Faculty Secretary)
  </h4>
  <div class="d-flex gap-2">
    <a href="faculty_secretary_profile.html" class="btn btn-outline-info rounded-pill">
      <i class="fa-solid fa-user-circle me-1"></i> Profile
    </a>
    <button onclick="logout()" class="btn btn-outline-danger rounded-pill">
      <i class="fa-solid fa-arrow-right-from-bracket me-1"></i> Logout
    </button>
  </div>
</header>

<main class="page-bg d-flex justify-content-center align-items-center flex-column py-5">
  <!-- Form to add grade -->
  <div class="p-4 rounded-4 shadow" style="width: 90%; max-width: 700px; background-color: #94d0ff;">
    <h5 class="fw-bold text-center mb-4">Add Grade for Students</h5>
    <form id="addGradeForm">
      <div class="mb-3">
        <label class="form-label">Course Code</label>
        <select class="form-select" id="courseCode" required>
          <option value="ST102">ST102</option>
          <option value="DB202">DB202</option>
          <option value="EN101">EN101</option>
          <option value="MATH101">MATH101</option>
          <option value="MATH012">MATH012</option>
          <option value="HS205">HS205</option>
          <option value="PSY210">PSY210</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Student Name</label>
        <input type="text" class="form-control" id="studentName" placeholder="Enter Student Name" required />
      </div>
      <div class="mb-3">
        <label class="form-label">Student Number (9 digits)</label>
        <input type="text" class="form-control" id="studentNumber" placeholder="Enter Student Number" maxlength="9" required />
      </div>
      <div class="mb-3">
        <label class="form-label">Grade Letter</label>
        <input type="text" class="form-control" id="grade" placeholder="Enter Grade Letter" required />
      </div>
      <button type="submit" class="btn btn-primary w-100 rounded-pill">Add Grade</button>
    </form>
    
    <!-- Upload Excel Button -->
    <button class="btn btn-info w-100 rounded-pill mt-3" data-bs-toggle="modal" data-bs-target="#uploadExcelModal">
      Upload Excel File
    </button>
  </div>

  <!-- Table to display added students -->
  <div class="p-4 rounded-4 shadow mt-4" style="width: 90%; max-width: 700px; background-color: #f0f4f8;">
    <h5 class="fw-bold text-center mb-4">Added Students</h5>
    <table class="table table-bordered" id="studentsTable">
      <thead>
        <tr>
          <th>Student Name</th>
          <th>Student Number</th>
          <th>Course Code</th>
          <th>Grade Letter</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="studentsTableBody">
        <!-- Dynamic rows will be added here -->
      </tbody>
    </table>
    <button class="btn btn-secondary" onclick="printTable()">Print Table</button>
  </div>
</main>

<!-- Modal for Uploading Excel File -->
<div class="modal fade" id="uploadExcelModal" tabindex="-1" aria-labelledby="uploadExcelModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold" id="uploadExcelModalLabel">Upload Excel File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls" />
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-primary w-100 fw-bold rounded-pill" onclick="uploadExcel()">Upload</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Editing Student -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold" id="editStudentModalLabel">Edit Student</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Student Name</label>
          <input type="text" class="form-control" id="editStudentName" />
        </div>
        <div class="mb-3">
          <label class="form-label">Student Number</label>
          <input type="text" class="form-control" id="editStudentNumber" />
        </div>
        <div class="mb-3">
          <label class="form-label">Grade Letter</label>
          <input type="text" class="form-control" id="editGrade" />
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-primary w-100 fw-bold rounded-pill" onclick="saveStudentEdits()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script src="init.js"></script>

<script>
  // حماية الصفحة - تأكيد أن اليوزر Faculty Secretary فقط
  const userType = localStorage.getItem("userType");
  if (userType !== "faculty") { 
    window.location.href = "index.html"; 
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
// Helper function to convert Arabic numbers to English
function convertArabicNumbersToEnglish(str) {
  const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
  const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
  return str.replace(/[٠١٢٣٤٥٦٧٨٩]/g, match => englishNumbers[arabicNumbers.indexOf(match)]);
}

// Update students table on page load
document.addEventListener('DOMContentLoaded', updateStudentsTable);

// Update the students table with data from localStorage
function updateStudentsTable() {
  const students = JSON.parse(localStorage.getItem('students')) || [];
  const tableBody = document.getElementById('studentsTableBody');
  tableBody.innerHTML = ''; // Clear the table before updating
  students.forEach(student => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${student.studentName}</td>
      <td>${student.studentNumber}</td>
      <td>${student.courseCode}</td>
      <td>${student.grade}</td>
      <td>
        <button class="btn btn-warning btn-sm" onclick="openEditModal('${student.studentNumber}')">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.studentNumber}')">Delete</button>
      </td>
    `;
    tableBody.appendChild(row);
  });
}

// Logout function
function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

// Add grade function
document.getElementById('addGradeForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const courseCode = document.getElementById('courseCode').value;
  const studentName = document.getElementById('studentName').value;
  let studentNumber = document.getElementById('studentNumber').value;
  const grade = document.getElementById('grade').value;

  // Convert Arabic numbers to English
  studentNumber = convertArabicNumbersToEnglish(studentNumber);

  // Capitalize the first letter of the student's name
  const formattedStudentName = studentName.charAt(0).toUpperCase() + studentName.slice(1).toLowerCase();

  // Validate student number length
  if (studentNumber.length !== 9) {
    alert("Student number must be exactly 9 digits.");
    return;
  }

  // Store data in localStorage
  let students = JSON.parse(localStorage.getItem('students')) || [];
  students.push({ studentName: formattedStudentName, studentNumber, courseCode, grade });
  localStorage.setItem('students', JSON.stringify(students));

  // Update the table and reset the form
  updateStudentsTable();
  this.reset();
});

// Edit student modal function
function openEditModal(studentNumber) {
  const students = JSON.parse(localStorage.getItem('students')) || [];
  const student = students.find(student => student.studentNumber === studentNumber);

  if (student) {
    document.getElementById('editStudentName').value = student.studentName;
    document.getElementById('editStudentNumber').value = student.studentNumber;
    document.getElementById('editGrade').value = student.grade;
    
    // Open modal
    const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
    modal.show();
  }
}

// Save student edits
function saveStudentEdits() {
  const studentNumber = document.getElementById('editStudentNumber').value;
  const newStudentName = document.getElementById('editStudentName').value;
  const newGrade = document.getElementById('editGrade').value;

  // Get students from localStorage
  let students = JSON.parse(localStorage.getItem('students')) || [];

  // Find the student to edit
  const studentIndex = students.findIndex(student => student.studentNumber === studentNumber);

  if (studentIndex !== -1) {
    // Update student data in localStorage
    students[studentIndex].studentName = newStudentName;
    students[studentIndex].grade = newGrade;
    
    // Save the updated list back to localStorage
    localStorage.setItem('students', JSON.stringify(students));
    
    // Update the table after saving the changes
    updateStudentsTable();

    // Close the modal after saving
    const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
    modal.hide();

    alert("Student data updated successfully!");
  }
}

// Delete student function
function deleteStudent(studentNumber) {
  let students = JSON.parse(localStorage.getItem('students')) || [];
  students = students.filter(student => student.studentNumber !== studentNumber);
  localStorage.setItem('students', JSON.stringify(students));

  // Update the table after deleting
  updateStudentsTable();
}

// Print table function
function printTable() {
  const table = document.getElementById('studentsTable');
  const newWindow = window.open('', '', 'height=500,width=800');
  newWindow.document.write('<html><head><title>Print Students Table</title></head><body>');
  newWindow.document.write(table.outerHTML);
  newWindow.document.write('<style>td:last-child {display: none;}</style>'); // Hide the "Action" column
  newWindow.document.write('</body></html>');
  newWindow.print();
  newWindow.close();
}

// Upload Excel function
function uploadExcel() {
  const fileInput = document.getElementById('excelFile');
  const file = fileInput.files[0];
  const uploadButton = document.querySelector('[onclick="uploadExcel()"]'); // Select the upload button
  uploadButton.disabled = true; // Disable button during file upload
  
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const data = e.target.result;
      const workbook = XLSX.read(data, { type: 'array' }); // Use 'array' instead of 'binary'
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(sheet);  // Convert data from Excel to JSON

      // Process the Excel data and update the table
      jsonData.forEach(row => {
        const studentName = row['Student Name'];
        const studentNumber = row['Student Number'];
        const courseCode = row['Course Code'];
        const grade = row['Grade'];

        // Add the data to localStorage
        let students = JSON.parse(localStorage.getItem('students')) || [];
        students.push({ studentName, studentNumber, courseCode, grade });
        localStorage.setItem('students', JSON.stringify(students));

        // Update the table
        updateStudentsTable();
      });

      // Close the modal after file upload
      $('#uploadExcelModal').modal('hide');  
      
      // Re-enable the upload button after uploading
      uploadButton.disabled = false;

      // Clear the file input field to allow the user to select a new file
      fileInput.value = ''; 

      alert('Excel file uploaded successfully!');
    };
    reader.readAsArrayBuffer(file);  // Read file as an array (better performance)
  }
}

</script>

</body>
</html>